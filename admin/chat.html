<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Chat | Arthuzist Admin</title>
    <script>
        if (location.hostname === 'arthuzist.com') {
            location.href = location.href.replace('arthuzist.com', 'www.arthuzist.com');
        }
    </script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }

        .app { display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar { width: 350px; background: #000; border-right: 1px solid #262626; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #262626; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h1 { font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .sidebar-header h1 span { color: #f5c518; }
        .back-btn { background: none; border: none; color: #888; font-size: 14px; cursor: pointer; text-decoration: none; }
        .back-btn:hover { color: #f5c518; }

        .ticket-list { flex: 1; overflow-y: auto; }
        .ticket-item { display: flex; gap: 12px; padding: 16px 20px; cursor: pointer; border-bottom: 1px solid #262626; transition: background 0.2s; }
        .ticket-item:hover { background: #1a1a1a; }
        .ticket-item.active { background: #262626; }
        .ticket-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #f5c518, #d4a817); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; flex-shrink: 0; }
        .ticket-info { flex: 1; min-width: 0; }
        .ticket-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .ticket-name { font-weight: 600; font-size: 14px; }
        .ticket-time { font-size: 12px; color: #666; }
        .ticket-preview { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ticket-meta { display: flex; gap: 8px; margin-top: 4px; align-items: center; }
        .ticket-id { font-size: 11px; color: #f5c518; font-family: monospace; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .badge-open { background: #0f3d0f; color: #4ade80; }
        .badge-pending { background: #3d3d0f; color: #facc15; }
        .badge-closed { background: #3d0f0f; color: #f87171; }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #000; }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid #262626; display: flex; align-items: center; gap: 16px; background: #000; }
        .chat-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #f5c518, #d4a817); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; }
        .chat-info h2 { font-size: 16px; font-weight: 600; }
        .chat-info p { font-size: 13px; color: #888; }
        .chat-info p span { color: #f5c518; font-family: monospace; }
        .chat-actions { margin-left: auto; display: flex; gap: 8px; }
        .chat-actions button { padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; border: none; }
        .btn-close { background: #22c55e; color: #000; }
        .btn-reopen { background: #3b82f6; color: #fff; }
        .btn-delete { background: #ef4444; color: #fff; }
        .btn-mute { background: #f97316; color: #fff; }
        .btn-unmute { background: #8b5cf6; color: #fff; }

        /* Messages */
        .messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 8px; }
        .date-divider { text-align: center; margin: 16px 0; }
        .date-divider span { background: #262626; padding: 6px 16px; border-radius: 20px; font-size: 12px; color: #888; }

        .msg { max-width: 65%; display: flex; flex-direction: column; }
        .msg.user { align-self: flex-end; }
        .msg.admin { align-self: flex-start; }
        .msg-name { font-size: 11px; color: #888; margin-bottom: 4px; padding: 0 12px; }
        .msg.user .msg-name { text-align: right; }
        .msg.admin .msg-name { color: #f5c518; }
        .msg-bubble { padding: 12px 16px; border-radius: 20px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
        .msg.user .msg-bubble { background: #262626; border-radius: 20px 20px 4px 20px; }
        .msg.admin .msg-bubble { background: linear-gradient(135deg, #f5c518, #d4a817); color: #000; border-radius: 20px 20px 20px 4px; }
        .msg-time { font-size: 11px; color: #666; margin-top: 4px; padding: 0 12px; }
        .msg.user .msg-time { text-align: right; }
        .msg-image { max-width: 250px; border-radius: 12px; margin-top: 8px; cursor: pointer; }

        /* Reply */
        .reply-area { padding: 16px 24px; border-top: 1px solid #262626; background: #000; }
        .reply-box { display: flex; align-items: flex-end; gap: 12px; background: #262626; border-radius: 24px; padding: 8px 8px 8px 20px; }
        .reply-box textarea { flex: 1; background: none; border: none; color: #fff; font-size: 14px; resize: none; max-height: 120px; padding: 8px 0; line-height: 1.4; }
        .reply-box textarea:focus { outline: none; }
        .reply-box textarea::placeholder { color: #666; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #f5c518; color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .send-btn:hover { transform: scale(1.1); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Empty State */
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h3 { font-size: 20px; color: #888; margin-bottom: 8px; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; transform: translateX(200%); transition: transform 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: #22c55e; }
        .toast.error { border-color: #ef4444; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; width: 100%; z-index: 100; transition: left 0.3s; }
            .sidebar.open { left: 0; }
            .chat-area { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><span>‚≠ê</span> Support</h1>
                <a href="index.html" class="back-btn">‚Üê Dashboard</a>
            </div>
            <div class="ticket-list" id="ticketList"></div>
        </aside>

        <main class="chat-area">
            <div class="empty-state" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <h3>Select a Ticket</h3>
                <p>Choose a conversation from the sidebar</p>
            </div>

            <div id="chatView" style="display:none;flex:1;flex-direction:column;">
                <div class="chat-header">
                    <div class="chat-avatar" id="chatAvatar">U</div>
                    <div class="chat-info">
                        <h2 id="chatName">User</h2>
                        <p><span id="chatTicketId">TKT123</span> ¬∑ <span id="chatStatus">Open</span></p>
                    </div>
                    <div class="chat-actions">
                        <button class="btn-mute" id="btnMute" onclick="toggleMute()">üîá Mute</button>
                        <button class="btn-close" id="btnClose" onclick="closeTicket()">‚úÖ Close</button>
                        <button class="btn-reopen" id="btnReopen" onclick="reopenTicket()" style="display:none;">üîÑ Reopen</button>
                        <button class="btn-delete" onclick="deleteTicket()">üóëÔ∏è Delete</button>
                    </div>
                </div>

                <div class="messages" id="messages"></div>

                <div class="reply-area" id="replyArea">
                    <div class="reply-box">
                        <textarea id="msgInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    const API = '/api';
    let tickets = [];
    let currentTicket = null;
    let refreshInterval = null;

    // Helpers
    let cachedToken = null;

    function getToken() {
        if (cachedToken) return cachedToken;

        const hash = window.location.hash;
        if (hash && hash.startsWith('#token=')) {
            cachedToken = decodeURIComponent(hash.substring(7));
            try {
                localStorage.setItem('arthuzist_token', cachedToken);
                sessionStorage.setItem('arthuzist_token', cachedToken);
            } catch(e) {}
            document.cookie = `arthuzist_client_token=${cachedToken};path=/;max-age=3600;SameSite=Lax`;
            history.replaceState(null, '', window.location.pathname + window.location.search);
            return cachedToken;
        }

        try {
            cachedToken = localStorage.getItem('arthuzist_token');
            if (cachedToken) return cachedToken;
        } catch(e) {}

        try {
            cachedToken = sessionStorage.getItem('arthuzist_token');
            if (cachedToken) return cachedToken;
        } catch(e) {}

        const match = document.cookie.match(/arthuzist_client_token=([^;]+)/);
        if (match) {
            cachedToken = match[1];
            return cachedToken;
        }
        return null;
    }

    async function api(url, opts = {}) {
        const token = getToken();
        if (!token) {
            location.href = '../auth.html';
            return;
        }
        try {
            const res = await fetch(API + url, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                ...opts
            });
            if (res.status === 401) {
                cachedToken = null;
                try { localStorage.removeItem('arthuzist_token'); } catch(e) {}
                try { sessionStorage.removeItem('arthuzist_token'); } catch(e) {}
                document.cookie = 'arthuzist_client_token=;path=/;max-age=0';
                location.href = '../auth.html';
                return;
            }
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Error');
            return data;
        } catch(err) {
            console.error('API error:', err);
            throw err;
        }
    }

    function toast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast show ' + type;
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function esc(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function formatTime(d) {
        const date = new Date(d);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function formatDate(d) {
        return new Date(d).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
        const token = getToken();
        if (!token) {
            location.href = '../auth.html';
            return;
        }
        try {
            const data = await api('/auth?action=me');
            if (!data?.user || data.user.role !== 'admin') {
                alert('Access denied. Admin only.');
                location.href = '../auth.html';
                return;
            }
            await loadTickets();

            // Check URL for ticket ID
            const params = new URLSearchParams(location.search);
            const ticketId = params.get('id');
            if (ticketId) {
                selectTicket(ticketId);
            }

            // Auto refresh
            refreshInterval = setInterval(() => {
                loadTickets();
                if (currentTicket) loadMessages();
            }, 10000);
        } catch (e) {
            location.href = '../auth.html';
        }
    });

    // Load tickets
    async function loadTickets() {
        try {
            const data = await api('/tickets');
            tickets = data.tickets || [];
            renderTicketList();
        } catch (e) {
            console.error('Load tickets:', e);
        }
    }

    function renderTicketList() {
        const el = document.getElementById('ticketList');
        if (!tickets.length) {
            el.innerHTML = '<div style="padding:40px;text-align:center;color:#666;">No tickets</div>';
            return;
        }
        el.innerHTML = tickets.map(t => `
            <div class="ticket-item ${currentTicket?.id === t.id ? 'active' : ''}" onclick="selectTicket('${t.id}')">
                <div class="ticket-avatar">${(t.users?.name || 'U')[0].toUpperCase()}</div>
                <div class="ticket-info">
                    <div class="ticket-top">
                        <span class="ticket-name">${esc(t.users?.name || 'Unknown')}</span>
                        <span class="ticket-time">${formatTime(t.updated_at || t.created_at)}</span>
                    </div>
                    <div class="ticket-preview">${esc(t.subject)}</div>
                    <div class="ticket-meta">
                        <span class="ticket-id">${t.ticket_number}</span>
                        <span class="badge badge-${t.status}">${t.status}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Select ticket
    async function selectTicket(id) {
        currentTicket = tickets.find(t => t.id === id);
        if (!currentTicket) {
            // Fetch if not in list
            try {
                const data = await api('/tickets/' + id);
                currentTicket = data.ticket;
            } catch (e) {
                toast('Ticket not found', 'error');
                return;
            }
        }

        // Update URL
        history.replaceState(null, '', '?id=' + id);

        // Show chat
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chatView').style.display = 'flex';

        // Update header
        document.getElementById('chatAvatar').textContent = (currentTicket.users?.name || 'U')[0].toUpperCase();
        document.getElementById('chatName').textContent = currentTicket.users?.name || 'Unknown User';
        document.getElementById('chatTicketId').textContent = currentTicket.ticket_number;
        document.getElementById('chatStatus').textContent = currentTicket.status;

        // Show/hide buttons
        const isClosed = currentTicket.status === 'closed';
        document.getElementById('btnClose').style.display = isClosed ? 'none' : 'block';
        document.getElementById('btnReopen').style.display = isClosed ? 'block' : 'none';
        document.getElementById('replyArea').style.display = isClosed ? 'none' : 'block';
        updateMuteButton();

        renderTicketList();
        await loadMessages();
    }

    // Load messages
    async function loadMessages() {
        if (!currentTicket) return;
        try {
            const data = await api('/tickets/' + currentTicket.id + '/messages');
            const msgs = data.messages || [];
            renderMessages(msgs);
        } catch (e) {
            console.error('Load messages:', e);
        }
    }

    function renderMessages(msgs) {
        const el = document.getElementById('messages');
        if (!msgs.length) {
            el.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">No messages yet</div>';
            return;
        }

        let html = '';
        let lastDate = '';

        msgs.forEach(m => {
            const date = formatDate(m.created_at);
            if (date !== lastDate) {
                html += `<div class="date-divider"><span>${date}</span></div>`;
                lastDate = date;
            }

            const isAdmin = m.is_admin;
            html += `
                <div class="msg ${isAdmin ? 'admin' : 'user'}">
                    <div class="msg-name">${isAdmin ? 'Arthuzist Support' : esc(m.author_name || 'User')}</div>
                    <div class="msg-bubble">${esc(m.message || m.content)}</div>
                    ${m.attachments?.length ? m.attachments.map(a => `<img src="${esc(a.url || a)}" class="msg-image" onclick="window.open(this.src)">`).join('') : ''}
                    <div class="msg-time">${formatTime(m.created_at)}</div>
                </div>
            `;
        });

        el.innerHTML = html;
        el.scrollTop = el.scrollHeight;
    }

    // Send message - instant optimistic update
    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text || !currentTicket) return;

        input.value = '';
        input.style.height = 'auto';

        // Instant optimistic update - add message to UI immediately
        const tempMsg = {
            id: 'temp-' + Date.now(),
            message: text,
            is_admin: true,
            author_name: 'You',
            created_at: new Date().toISOString()
        };
        appendMessage(tempMsg);

        try {
            await api('/tickets/' + currentTicket.id + '/messages', {
                method: 'POST',
                body: JSON.stringify({ message: text })
            });
        } catch (e) {
            toast(e.message, 'error');
            loadMessages(); // Reload on error
        }
    }

    // Append single message to chat (for instant updates)
    function appendMessage(m) {
        const el = document.getElementById('messages');
        const isAdmin = m.is_admin;
        const html = `
            <div class="msg ${isAdmin ? 'admin' : 'user'}">
                <div class="msg-name">${isAdmin ? 'Arthuzist Support' : esc(m.author_name || 'User')}</div>
                <div class="msg-bubble">${esc(m.message || m.content)}</div>
                <div class="msg-time">${formatTime(m.created_at)}</div>
            </div>
        `;
        el.insertAdjacentHTML('beforeend', html);
        el.scrollTop = el.scrollHeight;
    }

    // Input handling
    document.getElementById('msgInput')?.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    document.getElementById('msgInput')?.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Actions
    async function closeTicket() {
        if (!currentTicket) return;
        try {
            await api('/tickets/' + currentTicket.id + '/messages', {
                method: 'POST',
                body: JSON.stringify({ message: 'üéâ This ticket has been resolved. Thank you for contacting Arthuzist Support! If you enjoyed our service, please leave us a review. Have a great day!' })
            });
            await api('/tickets/' + currentTicket.id, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'closed' })
            });
            currentTicket.status = 'closed';
            await loadTickets();
            selectTicket(currentTicket.id);
            toast('Ticket closed!');
        } catch (e) {
            toast(e.message, 'error');
        }
    }

    async function reopenTicket() {
        if (!currentTicket) return;
        try {
            await api('/tickets/' + currentTicket.id + '/messages', {
                method: 'POST',
                body: JSON.stringify({ message: 'üîÑ This ticket has been reopened. Our team will continue assisting you.' })
            });
            await api('/tickets/' + currentTicket.id, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'open' })
            });
            currentTicket.status = 'open';
            await loadTickets();
            selectTicket(currentTicket.id);
            toast('Ticket reopened!');
        } catch (e) {
            toast(e.message, 'error');
        }
    }

    async function deleteTicket() {
        if (!currentTicket) return;
        if (!confirm('‚ö†Ô∏è Delete this ticket permanently?')) return;
        try {
            await api('/tickets/' + currentTicket.id, { method: 'DELETE' });
            toast('Ticket deleted!');
            currentTicket = null;
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            history.replaceState(null, '', 'chat.html');
            await loadTickets();
        } catch (e) {
            toast(e.message, 'error');
        }
    }

    // Mute/Unmute user
    async function toggleMute() {
        if (!currentTicket || !currentTicket.user_id) return;
        const userId = currentTicket.user_id;
        const isMuted = currentTicket.users?.banned;

        try {
            await api('/admin?action=users/' + userId + '/ban', {
                method: 'PATCH',
                body: JSON.stringify({ banned: !isMuted })
            });

            // Update local state
            if (currentTicket.users) {
                currentTicket.users.banned = !isMuted;
            }
            updateMuteButton();
            toast(isMuted ? 'User unmuted!' : 'User muted!');
        } catch (e) {
            toast(e.message, 'error');
        }
    }

    function updateMuteButton() {
        const btn = document.getElementById('btnMute');
        const isMuted = currentTicket?.users?.banned;
        if (isMuted) {
            btn.textContent = 'üîä Unmute';
            btn.className = 'btn-unmute';
        } else {
            btn.textContent = 'üîá Mute';
            btn.className = 'btn-mute';
        }
    }
    </script>
</body>
</html>
